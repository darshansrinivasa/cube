{% comment %}
  Renders a list of product's price (regular, sale)

  Accepts:
  - product: {Object} Product Liquid object (optional)
  - placeholder: {Boolean} Renders placeholder price (optional)
  - use_variant: {Boolean} Use selected variant pricing instead of product pricing
  - show_badges: {Boolean} Show sale/sold-out tags
  - price_class: {String} add classes
  - show_compare_at_price: {Boolean} Show compare at price
  - is_subscription: {Boolean} Apply subscription discount calculation
  - is_double: {Boolean} calculates price based on selection

  Usage:
  {% render 'cube-price', product: product %}
  {% render 'cube-price', product: product, is_subscription: true, is_double: true %}
{% endcomment %}

{%- liquid
  # Determine target (variant or product)
  if use_variant
    assign target = product.selected_or_first_available_variant
  elsif placeholder
    assign target = null
  else
    assign target = product
  endif

  assign compare_at_price = target.compare_at_price
  assign price = target.price | default: 1999
  assign available = target.available | default: false
  assign money_price = price | money_without_trailing_zeros

  assign is_double = is_double | default: false
  assign subscription_enabled = is_subscription | default: false
  
  if subscription_enabled
    assign subscription_discount = product.metafields.custom.subscription_discount_value | times: 0.01
    assign base_price = compare_at_price

    assign subscription_discount_amount = base_price | times: subscription_discount
    assign subscription_price = base_price | minus: subscription_discount_amount

    if compare_at_price > price
      assign salevalue = compare_at_price | minus: price
      assign sale_percenatge = salevalue | times: 100 | divided_by: compare_at_price
      assign sale_multiplier = sale_percenatge | divided_by: 100.0
      assign sale_discount_on_subscription = subscription_price | times: sale_multiplier
      assign subscription_price_after_sale = subscription_price | minus: sale_discount_on_subscription
      if is_double
        assign compare_at_price = compare_at_price | times: 2
        assign subscription_price_after_sale = subscription_price_after_sale | times: 2
      endif
    endif

    assign money_price = subscription_price_after_sale | money
  endif
-%}

{%- unless target == null and placeholder == null -%}
<div
  class="
    price
    {% if price_class %} {{ price_class }}{% endif %}
    {% if available == false %} price--sold-out{% endif %}
    {% if compare_at_price > price and product.quantity_price_breaks_configured? != true %} price--on-sale{% endif %}
    {% if product.price_varies == false and product.compare_at_price_varies %} price--no-compare{% endif %}
  "
>
  <div class="price__container" 
    {% if subscription_enabled %}
      data-subscription-value="{{ product.metafields.custom.subscription_discount_value.value }}"
    {% endif %}
    {{  }}
    {% if is_double %}
      data-double_variant="true"
    {% endif %}
  >
    <div class="price__sale">
      <span class="visually-hidden visually-hidden--inline">
        {{ 'products.product.price.sale_price' | t }}
      </span>

      <span class="price-item price-item--sale price-item--last">
        {{ money_price }}
      </span>

      {%- unless product.price_varies == false and product.compare_at_price_varies -%}
        {% if compare_at_price > price %}
          <span class="visually-hidden visually-hidden--inline">
            {{ 'products.product.price.regular_price' | t }}
          </span>

          <span>
            <s class="price-item price-item--regular">
              {{ compare_at_price | money_without_trailing_zeros }}
            </s>
          </span>
        {% endif %}
      {%- endunless -%}

    </div>
  </div>
</div>
{% endunless %}
